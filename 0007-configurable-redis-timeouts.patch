From 3d637d5f2615ba62a3772a491d512de5b2ea5879 Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Sun, 16 Nov 2025 23:49:30 +0000
Subject: [PATCH] Make Redis socket timeouts configurable via environment
 variables

- Add MCP_REDIS_CONNECT_TIMEOUT env var (default: 5s, up from hardcoded 2s)
- Add MCP_REDIS_SOCKET_TIMEOUT env var (default: 5s, up from hardcoded 2s)
- Update .env.example with new configuration options
- Add comprehensive test suite for timeout configuration
- Maintains backward compatibility with existing deployments

Fixes F10: Hardcoded 2-second timeouts were too aggressive for
high-latency or loaded Redis instances
---
 .env.example                        |   2 +
 server.py                           |  33 ++++++++-
 test_redis_timeout_configuration.py | 110 ++++++++++++++++++++++++++++
 3 files changed, 142 insertions(+), 3 deletions(-)
 create mode 100644 test_redis_timeout_configuration.py

diff --git a/.env.example b/.env.example
index 5009c9b..3986f5c 100644
--- a/.env.example
+++ b/.env.example
@@ -5,6 +5,8 @@
 MCP_MEMORY_REDIS_HOST=localhost
 MCP_MEMORY_REDIS_PORT=6379
 MCP_MEMORY_REDIS_DB=5
+MCP_REDIS_CONNECT_TIMEOUT=5
+MCP_REDIS_SOCKET_TIMEOUT=5
 
 # Project Root (defaults to current working directory)
 # MCP_RUNTIME_PROJECT_ROOT=/path/to/project
diff --git a/server.py b/server.py
index defcef8..26ff919 100644
--- a/server.py
+++ b/server.py
@@ -24,11 +24,12 @@ import asyncio
 import functools
 import json
 import os
+import signal
 import subprocess
 import sys
 import time
 import uuid
-from contextlib import asynccontextmanager
+from contextlib import asynccontextmanager, contextmanager
 from dataclasses import dataclass
 from pathlib import Path
 from typing import Any, Dict, List, Optional
@@ -63,6 +64,8 @@ PROJECT_ROOT = Path(os.getenv("MCP_RUNTIME_PROJECT_ROOT", os.getcwd())).resolve(
 REDIS_HOST = os.getenv("MCP_MEMORY_REDIS_HOST", "localhost")
 REDIS_PORT = int(os.getenv("MCP_MEMORY_REDIS_PORT", "6379"))
 REDIS_DB = int(os.getenv("MCP_MEMORY_REDIS_DB", "5"))
+REDIS_CONNECT_TIMEOUT = int(os.getenv("MCP_REDIS_CONNECT_TIMEOUT", "5"))
+REDIS_SOCKET_TIMEOUT = int(os.getenv("MCP_REDIS_SOCKET_TIMEOUT", "5"))
 
 # Initialize Redis client without blocking ping
 redis_client: Optional[redis.Redis] = redis.Redis(
@@ -70,8 +73,8 @@ redis_client: Optional[redis.Redis] = redis.Redis(
     port=REDIS_PORT,
     db=REDIS_DB,
     decode_responses=True,
-    socket_connect_timeout=2,
-    socket_timeout=2,
+    socket_connect_timeout=REDIS_CONNECT_TIMEOUT,
+    socket_timeout=REDIS_SOCKET_TIMEOUT,
 )
 MEMORY_ENABLED = False  # Will be set to True after successful async check
 
@@ -228,6 +231,30 @@ def _json_safe(value: Any) -> Any:
         return repr(value)
 
 
+def _safe_json_dumps(obj: Any, context: str = "") -> str:
+    """
+    Safely serialize object to JSON with fallback for non-serializable types.
+
+    Args:
+        obj: Object to serialize
+        context: Description of what's being serialized (for logging)
+
+    Returns:
+        JSON string
+    """
+    try:
+        return json.dumps(obj, ensure_ascii=False)
+    except (TypeError, ValueError) as e:
+        log.warning(f"JSON serialization failed for {context}: {e}. Using fallback.")
+        # Try with custom JSON encoder
+        try:
+            return json.dumps(obj, default=str, ensure_ascii=False)
+        except Exception as e2:
+            log.error(f"Fallback serialization also failed for {context}: {e2}")
+            # Last resort: use repr
+            return json.dumps({"_repr": repr(obj), "_error": str(e)})
+
+
 # Wrap tools to auto-log calls into Redis
 _original_tool_decorator = mcp.tool
 
diff --git a/test_redis_timeout_configuration.py b/test_redis_timeout_configuration.py
new file mode 100644
index 0000000..3b728cf
--- /dev/null
+++ b/test_redis_timeout_configuration.py
@@ -0,0 +1,110 @@
+"""
+Test Redis timeout configuration via environment variables.
+Verifies that MCP_REDIS_CONNECT_TIMEOUT and MCP_REDIS_SOCKET_TIMEOUT
+environment variables are properly applied to the Redis client.
+"""
+
+import os
+import sys
+import unittest
+from unittest.mock import patch, MagicMock
+
+# Mock sentence_transformers before any imports
+sys.modules['sentence_transformers'] = MagicMock()
+
+
+class TestRedisTimeoutConfiguration(unittest.TestCase):
+    """Test cases for Redis timeout configuration."""
+
+    def setUp(self):
+        """Reset environment and module cache before each test."""
+        # Clear any existing timeout env vars
+        for key in ['MCP_REDIS_CONNECT_TIMEOUT', 'MCP_REDIS_SOCKET_TIMEOUT']:
+            if key in os.environ:
+                del os.environ[key]
+
+        # Remove server module if already imported
+        if 'server' in sys.modules:
+            del sys.modules['server']
+
+    def test_default_timeout_values(self):
+        """Test that default timeout values are 5 seconds."""
+        with patch('redis.Redis') as mock_redis:
+            import server
+
+            # Verify default values are set correctly
+            self.assertEqual(server.REDIS_CONNECT_TIMEOUT, 5)
+            self.assertEqual(server.REDIS_SOCKET_TIMEOUT, 5)
+
+            # Verify Redis client was initialized with default timeouts
+            mock_redis.assert_called_once()
+            call_kwargs = mock_redis.call_args[1]
+            self.assertEqual(call_kwargs['socket_connect_timeout'], 5)
+            self.assertEqual(call_kwargs['socket_timeout'], 5)
+
+    def test_custom_timeout_values(self):
+        """Test that custom timeout values from environment are applied."""
+        os.environ['MCP_REDIS_CONNECT_TIMEOUT'] = '10'
+        os.environ['MCP_REDIS_SOCKET_TIMEOUT'] = '15'
+
+        with patch('redis.Redis') as mock_redis:
+            import server
+
+            # Verify custom values are set correctly
+            self.assertEqual(server.REDIS_CONNECT_TIMEOUT, 10)
+            self.assertEqual(server.REDIS_SOCKET_TIMEOUT, 15)
+
+            # Verify Redis client was initialized with custom timeouts
+            mock_redis.assert_called_once()
+            call_kwargs = mock_redis.call_args[1]
+            self.assertEqual(call_kwargs['socket_connect_timeout'], 10)
+            self.assertEqual(call_kwargs['socket_timeout'], 15)
+
+    def test_backward_compatibility(self):
+        """Test that system works without timeout env vars (backward compatible)."""
+        # Ensure no timeout env vars are set
+        for key in ['MCP_REDIS_CONNECT_TIMEOUT', 'MCP_REDIS_SOCKET_TIMEOUT']:
+            if key in os.environ:
+                del os.environ[key]
+
+        with patch('redis.Redis') as mock_redis:
+            import server
+
+            # Should fall back to defaults (5 seconds, improved from 2)
+            self.assertEqual(server.REDIS_CONNECT_TIMEOUT, 5)
+            self.assertEqual(server.REDIS_SOCKET_TIMEOUT, 5)
+
+            # Redis client should still initialize successfully
+            mock_redis.assert_called_once()
+
+    def test_timeout_values_are_integers(self):
+        """Test that timeout values are properly converted to integers."""
+        os.environ['MCP_REDIS_CONNECT_TIMEOUT'] = '7'
+        os.environ['MCP_REDIS_SOCKET_TIMEOUT'] = '9'
+
+        with patch('redis.Redis') as mock_redis:
+            import server
+
+            # Verify values are integers, not strings
+            self.assertIsInstance(server.REDIS_CONNECT_TIMEOUT, int)
+            self.assertIsInstance(server.REDIS_SOCKET_TIMEOUT, int)
+            self.assertEqual(server.REDIS_CONNECT_TIMEOUT, 7)
+            self.assertEqual(server.REDIS_SOCKET_TIMEOUT, 9)
+
+    def test_increased_from_original_hardcoded_values(self):
+        """Test that default values have been increased from original 2 seconds."""
+        with patch('redis.Redis') as mock_redis:
+            import server
+
+            # New defaults should be 5 seconds (increased from 2)
+            self.assertGreater(server.REDIS_CONNECT_TIMEOUT, 2)
+            self.assertGreater(server.REDIS_SOCKET_TIMEOUT, 2)
+
+            # Verify the improvement
+            call_kwargs = mock_redis.call_args[1]
+            self.assertEqual(call_kwargs['socket_connect_timeout'], 5)
+            self.assertEqual(call_kwargs['socket_timeout'], 5)
+
+
+if __name__ == '__main__':
+    unittest.main()
-- 
2.43.0

